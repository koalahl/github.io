<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>QRCode与Core Image | 寒流‘s Blog | 编程与生活</title>

  
  <meta name="author" content="Han Liu">
  

  
  <meta name="description" content="Think in Different">
  

  
  
  <meta name="keywords" content="QRCode,AVFoundation,CoreImage">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="QRCode与Core Image"/>

  <meta property="og:site_name" content="寒流‘s Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="寒流‘s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">寒流‘s Blog</a>
    </h1>
    <p class="site-description">编程与生活</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">首页</a></li>
      
        <li><a href="/categories/swiftOldDriver">老司机</a></li>
      
        <li><a href="/categories/Swift">Swift</a></li>
      
        <li><a href="/categories/graphic">图形图像</a></li>
      
        <li><a href="/link">技术博客</a></li>
      
        <li><a href="/life">生活</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>QRCode与Core Image</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/03/05/QRCode的那些事儿/" rel="bookmark">
        <time class="entry-date published" datetime="2016-03-05T14:31:06.000Z">
          2016-03-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>网上已经有很多关于二维码方面的文章了，写这篇文章的目的是因为要记录一个关于保存二维码图片到相册的问题，顺便回顾一下iOS开发中使用二维码的历史。好了，废话少说，让我们开始吧！</p>
<h2>要讨论的问题</h2><br>在参考<a href="http://www.appcoda.com/qr-code-generator-tutorial/" target="_blank" rel="noopener">Building a QR Code Generator with Core Image Filters</a>这篇文章，完成了二维码生成的栗子。<br>二维码的扫描则是用了AVFoundation框架来编写的<a href="https://github.com/koalahl/HLQRCode" target="_blank" rel="noopener">Github·HLQRCode</a>。最后想把生成的二维码图片保存到相册中却没有成功。<br>参考了网上的代码，使用了CIImag-&gt;CGImage-&gt;writeImageToAlbum的方式。<br><br><a id="more"></a><br>代码如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CIContext</span> * context = [<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">CGImageRef</span> cgimg = [context createCGImage:<span class="keyword">self</span>.qrcodeImg fromRect:[<span class="keyword">self</span>.qrcodeImg extent] ];</span><br><span class="line"></span><br><span class="line">ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];</span><br><span class="line">[library writeImageToSavedPhotosAlbum:cgimg metadata:[<span class="keyword">self</span>.qrcodeImg properties] completionBlock:^(<span class="built_in">NSURL</span> *assetURL, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(error != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        msg = <span class="string">@"保存图片失败"</span> ;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,assetURL);</span><br><span class="line">        msg = <span class="string">@"保存图片成功"</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="literal">nil</span></span><br><span class="line">                                                    message:msg</span><br><span class="line">                                                   delegate:<span class="keyword">self</span></span><br><span class="line">                                          cancelButtonTitle:<span class="string">@"确定"</span></span><br><span class="line">                                          otherButtonTitles:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    [alert show];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><br><br>但是这样无论怎么样都无法在相册中看到保存的二维码图片。还报错<code>message &quot;BSXPCMessage received error for message: Connection interrupted&quot;</code>。对比参考的代码都是一样的，却找不出原因。我就在文章评论中留言问了这个问题，后来一个朋友提出了解决方案，仔细一看顿时恍然大悟。<br><br><h2>解决方式及要点</h2>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CIContext</span> * context = [<span class="built_in">CIContext</span> contextWithOptions:@&#123;kCIContextUseSoftwareRenderer:@YES&#125;];</span><br></pre></td></tr></table></figure>
<p>看到区别了吗？是的，多了一个option参数<code>kCIContextUseSoftwareRenderer</code>.然后在development doc中查看了关于<code>contextWithOptions</code>方法的描述：<br>contextWithOptions:<br><blockquote><p>You can create a CPU-based context by providing the key kCIContextUseSoftwareRenderer. A CPU-based context supports larger input and output images than a GPU-based context. It also allows your app to perform processing in the background, such as when saving the rendered output to the Photo Library.</p>
<p>GPU rendering is faster than CPU rendering, but the resulting image is not displayed on the device until after is it copied to CPU memory and converted to another image type, such as a UIImage object.</p>
<footer><strong>@Apple Development Doc</strong><cite><a href="https://developer.apple.com/library/prerelease/ios/documentation/GraphicsImaging/Reference/QuartzCoreFramework/Classes/CIContext_Class/index.html#//apple_ref/occ/clm/CIContext/contextWithOptions:" target="_blank" rel="noopener">developer.apple.com/library/prerelease/ios/documentation/GraphicsImaging/Reference/QuartzCoreFramework/Classes/CIContext_Class/index.html#//apple_ref/occ/clm/CIContext/contextWithOptions:</a></cite></footer></blockquote></p>
<p>顿时觉得自己当时好笨，都没有想到去查一下开发文档。o(╯□╰)o</p>
<ul>
<li>NSString *kCIContextOutputColorSpace;       - A key for the color space to use for images before they are rendered to the context. 使用OpenGLES</li>
<li>NSString *kCIContextWorkingColorSpace;      - A key for the color space to use for image operations. 使用OpenGLES</li>
<li>NSString *kCIContextUseSoftwareRenderer;    - A key for enabling software renderer use. If the associated NSNumber object is YES, then the software renderer is required. 使用CPU</li>
<li>NSString *kCIContextPriorityRequestLow;     - A key for enabling low-priority GPU use.</li>
<li>NSString *kCIContextWorkingFormat;          - An option for the color format to use for intermediate results when rendering with the context.</li>
</ul>
<p><code>contextWithOptions</code>方法默认是在GPU上处理图像。根据不同的参数设置不同的处理方式。<br>以上这些其实不是很理解，囧。具体参考<a href="https://developer.apple.com/library/prerelease/ios/documentation/GraphicsImaging/Reference/QuartzCoreFramework/Classes/CIContext_Class/index.html#//apple_ref/doc/constant_group/Context_Options" target="_blank" rel="noopener">Context Options</a></p>
<p></p><h2>二维码的历史</h2><br>在iOS7以前，iOS开发使用二维码都是使用第三方库。比较流行的就是<code>ZXing</code>和<code>Zbar</code>了。<br>不说它们的实现原理了，遇到最多的问题就是与其他第三方库（比如支付宝SDK，百度地图SDK）继承在一起时出现duplicate symbol了。解决方法也很麻烦：修改源码，重新编译静态库.a文件。<p></p>
<p>不过现在很少用到二维码了，要用也要用系统自带的框架哟~！</p>
<p></p><h2>总结</h2><br>1.遇到问题先查看开发文档，再Google！<br>2.研究问题要深入！<br>后面学习一下Core Image的东西，还有与之的GPUImage库！<p></p>
<p></p><h2>参考文章</h2><br><a href="https://developer.apple.com/library/prerelease/ios/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_intro/ci_intro.html#//apple_ref/doc/uid/TP30001185" target="_blank" rel="noopener">Core Image Programming Guide</a><br><a href="http://stackoverflow.com/questions/26065808/bsxpcmessage-received-error-for-message-connection-interrupted/29872829#29872829" target="_blank" rel="noopener">BSXPCMessage received error for message: Connection interrupted</a><p></p>
<div align="center"><br>    <img src="http://i3.sinaimg.cn/edu/2015/0724/U1151P42DT20150724094518.jpg" alt="girl"><br></div>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/iOS/">iOS</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/QRCode/">QRCode</a><a href="/tags/AVFoundation/">AVFoundation</a><a href="/tags/CoreImage/">CoreImage</a>
    </span>
    

    </div>

    
  </div>
</article>

  
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'hanangellove';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>





    </main>

    <footer class="site-footer">
  <p class="site-info">
    <!--
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
  -->
    
    &copy; 2018 Han Liu
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>