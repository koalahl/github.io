<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  
    <meta name="description" content="Think in Different">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    Mapkit基本开发指南 |
    
    寒流‘s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-Mapkit基本开发指南" class="article article-type-post" itemscope itemprop="blogPost">

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Mapkit基本开发指南
    </h1>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/2018/07/27/Mapkit基本开发指南/" class="article-date">
  <time datetime="2018-07-27T06:29:49.000Z" itemprop="datePublished">2018-07-27</time>
</a>
        
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

      </div>
    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <p>MapKit是iOS自带的地图库。可以实现定位，地理编码，地图标注等功能。 </p>
<a id="more"></a>
<p>一：查看是否导入MapKit.framework。 xcode5.1之后会自动导入<br>二：创建地图<br>    创建地图对象: <code>_mapView = [[MKMapView alloc]initWithFrame:self.view.bounds];</code></p>
<pre><code>1.打开地图时的初始位置
    1.1 设置地图中心点center
    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CLLocationCoordinate2D</span> center = <span class="built_in">CLLocationCoordinate2DMake</span>(latitude, longitude);</span><br></pre></td></tr></table></figure>

    1.2设置地图可视范围 数字越小，可现实范围越小
    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MKCoordinateSpan</span> span = <span class="built_in">MKCoordinateSpanMake</span>(<span class="number">53</span><span class="number">-3</span>, <span class="number">135</span><span class="number">-73</span>);</span><br></pre></td></tr></table></figure>

    1.3设置region= cente+span
     <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">CLLocationCoordinate2D</span> center2 = <span class="built_in">CLLocationCoordinate2DMake</span>(<span class="number">22.54387</span>,<span class="number">113.950339</span>);</span><br><span class="line">	<span class="built_in">MKCoordinateSpan</span> span2 = <span class="built_in">MKCoordinateSpanMake</span>(<span class="number">0.1</span>, <span class="number">0.1</span>);</span><br><span class="line"><span class="built_in">MKCoordinateRegion</span> region2 = <span class="built_in">MKCoordinateRegionMake</span>(center2, span2);</span><br><span class="line">	[_mapView setRegion:region2 animated:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>

2.地图类型
    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MKMapTypeStandard</span> = <span class="number">0</span>,</span><br><span class="line"><span class="built_in">MKMapTypeSatellite</span>,</span><br><span class="line"><span class="built_in">MKMapTypeHybrid</span></span><br><span class="line"></span><br><span class="line">_mapView.mapType = <span class="built_in">MKMapTypeStandard</span>;</span><br></pre></td></tr></table></figure>

3.设置地图上显示内容
    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">showsPointsOfInterest</span><br><span class="line">showsBuildings</span><br><span class="line">showsTraffic</span><br></pre></td></tr></table></figure>
</code></pre><p>三： 获取当前点击位置的经纬度<br>3.1给地图对象添加手势：<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//长按放置大头针，并获取当前点击位置的经纬度</span></span><br><span class="line"><span class="built_in">UILongPressGestureRecognizer</span> *longPress = [[<span class="built_in">UILongPressGestureRecognizer</span> alloc]initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(whereAmI:)];</span><br><span class="line">[_mapView addGestureRecognizer:longPress];</span><br></pre></td></tr></table></figure></p>
<p>3.2创建地图编码器 CLGeocoder——地图编码器分为正向编码和反向编码。两种需要创建两个编码对象，不能公用。<br>    <code>_coder = [[CLGeocoder alloc]init];</code></p>
<p>3.2.1正向地理编码：：将中文地址–&gt;经纬度<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    [_coder geocodeAddressString:name completionHandler:^(<span class="built_in">NSArray</span> *placemarks, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Error:%@"</span>,[error localizedDescription]);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------------正向地理编码------------"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">CLPlacemark</span> * mark <span class="keyword">in</span> placemarks) &#123;</span><br><span class="line">            <span class="built_in">CLLocation</span> *location = mark.location;<span class="comment">//是对CLLocationCoordinate2D的封装</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"(纬度：%f,经度：%f)"</span>,location.coordinate.latitude,location.coordinate.longitude);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.name);<span class="comment">//位置的完整名称</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.thoroughfare);<span class="comment">//位置名称</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.locality);<span class="comment">//城市</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.subLocality);<span class="comment">//区</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.administrativeArea);<span class="comment">//省</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//1.添加标注（大头针）</span></span><br><span class="line"><span class="comment">//            MKPointAnnotation *ann = [[MKPointAnnotation alloc]init];</span></span><br><span class="line"><span class="comment">//            //2.设置标注位置</span></span><br><span class="line"><span class="comment">//            ann.coordinate = CLLocationCoordinate2DMake(location.coordinate.latitude,location.coordinate.longitude);</span></span><br><span class="line"><span class="comment">//            ann.title = mark.thoroughfare;</span></span><br><span class="line"><span class="comment">//            ann.subtitle = mark.name;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*也可以使用自定义的Annotation*/</span></span><br><span class="line">            HLAnnotation *ann = [[HLAnnotation alloc]initWithTitle:mark.thoroughfare subtitle:mark.name coordinate:<span class="built_in">CLLocationCoordinate2DMake</span>(location.coordinate.latitude, location.coordinate.longitude)];</span><br><span class="line">            <span class="comment">//3.将标注添加到地图上</span></span><br><span class="line">            [_mapView addAnnotation:ann];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure></p>
<p>3.2.2 反向地理编码：将经纬度—》中文地址信息<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[_coder reverseGeocodeLocation:location completionHandler:^(<span class="built_in">NSArray</span> *placemarks, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Error:%@"</span>,[error localizedDescription]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"------------反向地理编码------------"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">CLPlacemark</span> * mark <span class="keyword">in</span> placemarks) &#123;</span><br><span class="line">        <span class="built_in">CLLocation</span> *location = mark.location;<span class="comment">//是对CLLocationCoordinate2D的封装</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"(纬度：%f,经度：%f)"</span>,location.coordinate.latitude,location.coordinate.longitude);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.name);<span class="comment">//位置的完整名称</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.thoroughfare);<span class="comment">//位置名称</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.locality);<span class="comment">//城市</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.subLocality);<span class="comment">//区</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mark.administrativeArea);<span class="comment">//省</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.添加标注（大头针）</span></span><br><span class="line">        <span class="built_in">MKPointAnnotation</span> *ann = [[<span class="built_in">MKPointAnnotation</span> alloc]init];</span><br><span class="line">        <span class="comment">//2.设置标注位置</span></span><br><span class="line">        ann.coordinate = <span class="built_in">CLLocationCoordinate2DMake</span>(location.coordinate.latitude,location.coordinate.longitude);</span><br><span class="line">        ann.title = mark.thoroughfare;</span><br><span class="line">        ann.subtitle = mark.name;</span><br><span class="line">        <span class="comment">//3.将标注添加到地图上</span></span><br><span class="line">        [_mapView addAnnotation:ann];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>3.3 获取当前点击位置——-主要方法是 [tap locationInView：_mapView];获取当前点击的位置<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 点击地图，添加标注大头针</span></span><br><span class="line">- (<span class="keyword">void</span>)whereAmI:(<span class="built_in">UITapGestureRecognizer</span> *)tap&#123;</span><br><span class="line">    <span class="comment">//1.获取点击点的位置</span></span><br><span class="line">    <span class="built_in">CGPoint</span> point =  [tap locationInView:_mapView];</span><br><span class="line">    <span class="comment">//将点位置转换为当前经纬度</span></span><br><span class="line">    <span class="built_in">CLLocationCoordinate2D</span> locationCor = [_mapView convertPoint:point toCoordinateFromView:_mapView];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//NSLog(@"(纬度：%f,经度：%f)",locationCor.latitude,locationCor.longitude);</span></span><br><span class="line">    <span class="built_in">CLLocation</span> *location = [[<span class="built_in">CLLocation</span> alloc]initWithLatitude:locationCor.latitude longitude:locationCor.longitude];</span><br><span class="line">    [<span class="keyword">self</span> reverseGeocodeLocation:location];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.设置大头针的样式和状态——-需要遵守MKMapViewDelegate协议<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma  mark - MKMapViewDelegate</span></span><br><span class="line"><span class="comment">//也是有复用机制</span></span><br><span class="line">- (<span class="built_in">MKAnnotationView</span> *)mapView:(<span class="built_in">MKMapView</span> *)mapView viewForAnnotation:(<span class="keyword">id</span>&lt;<span class="built_in">MKAnnotation</span>&gt;)annotation;</span><br><span class="line"><span class="comment">//设置大头针的状态——重点两个：1.设置大头针（pin）的拖拽状态为end。2.更新大头针的标注（annotation）内容</span></span><br><span class="line">- (<span class="keyword">void</span>)mapView:(<span class="built_in">MKMapView</span> *)mapView annotationView:(<span class="built_in">MKAnnotationView</span> *)view didChangeDragState:(<span class="built_in">MKAnnotationViewDragState</span>)newState fromOldState:(<span class="built_in">MKAnnotationViewDragState</span>)oldState;</span><br></pre></td></tr></table></figure></p>
<p>//具体代码：<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">MKAnnotationView</span> *)mapView:(<span class="built_in">MKMapView</span> *)mapView viewForAnnotation:(<span class="keyword">id</span>&lt;<span class="built_in">MKAnnotation</span>&gt;)annotation&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"annotation的类型：%@"</span>,[annotation <span class="keyword">class</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1.先从复用队列中取出可用的大头针，如果没有，则创建</span></span><br><span class="line">    <span class="built_in">MKAnnotationView</span> *annView =  [mapView dequeueReusableAnnotationViewWithIdentifier:<span class="string">@"ann"</span>];</span><br><span class="line">    <span class="comment">//判断一下当前annotation的数据类型，如果是用户定位MKUserLocation类，则直接返回，这样当前位置的view就是一个蓝色小圆圈，而不是大头针。</span></span><br><span class="line">    <span class="keyword">if</span> ([annotation isKindOfClass:[<span class="built_in">MKUserLocation</span> <span class="keyword">class</span>]])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> annView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        annView = [[<span class="built_in">MKPinAnnotationView</span> alloc]initWithAnnotation:annotation reuseIdentifier:<span class="string">@"ann"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//MKPinAnnotationView是MKAnnotationView的子类</span></span><br><span class="line">    <span class="comment">//如果使用 annView = [MKPinAnnotationView alloc]</span></span><br><span class="line">    <span class="built_in">MKPinAnnotationView</span> *pin = (<span class="built_in">MKPinAnnotationView</span> *)annView;</span><br><span class="line">    <span class="comment">//pin.pinColor = MKPinAnnotationColorGreen;</span></span><br><span class="line">    pin.animatesDrop = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.设置大头针</span></span><br><span class="line">    <span class="comment">//2.1设置大头针图片</span></span><br><span class="line">    <span class="comment">//annView.image = [UIImage imageNamed:@"map"];</span></span><br><span class="line">    <span class="comment">//2.2设置拖拽</span></span><br><span class="line">    annView.draggable = <span class="literal">YES</span>;</span><br><span class="line">    <span class="comment">//2.3设置弹出泡泡</span></span><br><span class="line">    annView.canShowCallout = <span class="literal">YES</span>;</span><br><span class="line">    <span class="comment">//2.4设置左右视图</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIButton</span> * right = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeDetailDisclosure</span>];</span><br><span class="line">    right.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">    annView.rightCalloutAccessoryView = right;</span><br><span class="line"><span class="comment">//    annView.leftCalloutAccessoryView</span></span><br><span class="line">    <span class="keyword">return</span> annView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>//设置大头针的状态<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)mapView:(<span class="built_in">MKMapView</span> *)mapView annotationView:(<span class="built_in">MKAnnotationView</span> *)view didChangeDragState:(<span class="built_in">MKAnnotationViewDragState</span>)newState fromOldState:(<span class="built_in">MKAnnotationViewDragState</span>)oldState&#123;</span><br><span class="line">    <span class="keyword">if</span> (newState == <span class="built_in">MKAnnotationViewDragStateEnding</span>) &#123;</span><br><span class="line">        <span class="comment">//结束大头针View的拖拽状态</span></span><br><span class="line">        [view setDragState:<span class="built_in">MKAnnotationViewDragStateNone</span> animated:<span class="literal">YES</span>];</span><br><span class="line">        <span class="comment">//更新当前大头针的标注内容</span></span><br><span class="line">        HLAnnotation *ann = view.annotation;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"(%f,%f)"</span>,ann.coordinate.latitude,ann.coordinate.longitude);</span><br><span class="line">        <span class="built_in">CLLocation</span> *location = [[<span class="built_in">CLLocation</span> alloc]initWithLatitude:ann.coordinate.latitude longitude:ann.coordinate.longitude];</span><br><span class="line">        <span class="comment">//反向获取位置信息</span></span><br><span class="line">        [_coder reverseGeocodeLocation:location completionHandler:^(<span class="built_in">NSArray</span> *placemarks, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Error:%@"</span>,[error localizedDescription]);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"------------反向地理编码------------"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">CLPlacemark</span> * mark <span class="keyword">in</span> placemarks) &#123;</span><br><span class="line">                <span class="built_in">CLLocation</span> *location = mark.location;<span class="comment">//是对CLLocationCoordinate2D的封装</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//2.设置标注位置</span></span><br><span class="line">                ann.coordinate = <span class="built_in">CLLocationCoordinate2DMake</span>(location.coordinate.latitude,location.coordinate.longitude);</span><br><span class="line">                [ann setTitle:mark.thoroughfare];</span><br><span class="line">                [ann setSubtitle:mark.name];</span><br><span class="line">                <span class="comment">//3.将标注添加到地图上</span></span><br><span class="line">                [_mapView addAnnotation:ann];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>四：定位<br>用户定位与位置相关，所以使用的是CLLocationManager类。<br>1.打开用户位置显示开关<br>2.创建位置管理对象<br>3.设置精度和更新频率<br>4.启动位置更新<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建位置管理对象</span></span><br><span class="line">_manager = [[<span class="built_in">CLLocationManager</span> alloc]init];</span><br><span class="line">_mapView.showsUserLocation = <span class="literal">YES</span>;<span class="comment">//显示用户当前位置</span></span><br><span class="line"><span class="comment">//设置精度和更新频率</span></span><br><span class="line">_manager.desiredAccuracy = kCLLocationAccuracyNearestTenMeters;<span class="comment">//精度</span></span><br><span class="line">_manager.distanceFilter = <span class="number">100.0</span>;<span class="comment">//更新频率，每经过100m更新一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//启动定位，用完应该马上停止，定位结果在代理方法中获取</span></span><br><span class="line">_manager.delegate = <span class="keyword">self</span>;</span><br><span class="line">[_manager startUpdatingLocation];</span><br></pre></td></tr></table></figure></p>
<p>那么如何让地图自动跳转到定位的位置呢？这里需要实现协议CLLocationManagerDelegate。定位结果就是从协议方法中取得<br>    <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - CLLocationManagerDelegate</span></span><br><span class="line">- (<span class="keyword">void</span>)locationManager:(<span class="built_in">CLLocationManager</span> *)manager didUpdateLocations:(<span class="built_in">NSArray</span> *)locations&#123;</span><br><span class="line">    <span class="built_in">CLLocation</span> *currentLocation = [locations lastObject];</span><br><span class="line">    <span class="comment">//将地图移动到当前定位的位置</span></span><br><span class="line">    <span class="built_in">CLLocationCoordinate2D</span>  currentCoordinate = currentLocation.coordinate;</span><br><span class="line">    <span class="built_in">MKCoordinateSpan</span> span = _mapView.region.span;<span class="comment">//当前地图缩放比例</span></span><br><span class="line">    <span class="built_in">MKCoordinateRegion</span> region = &#123;currentCoordinate,span&#125;;</span><br><span class="line">    [_mapView setRegion:region];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"定位结束%@"</span>,currentLocation);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>五：多个经纬度做反向地理编码。</p>
<p>有个需求要求我们先把策划给的一张包含2664个城市经纬度的表，通过反向地理编码得出对应的城市名，在做的过程中遇到并处理了以下问题：<br>流程：<br>1.读取CVS文件，并写入数组中。<br>2.每次从数组中拿出50个数据，并判断是否finish。<br>3.创建定时器timer，实现一直循环第2步。<br>4.每次反向编码后的城市名写入文件中。</p>
<p>由于reverseGeocodeLocation处理经纬度的请求有限制：<br><code>reverseGeocodeLocation</code>方法有如下描述<br>    <blockquote><pre><code>Submits a reverse-geocoding request for the specified location.
</code></pre><p>This method submits the specified location data to the geocoding server asynchronously and returns. When the request completes, the geocoder executes the provided completion handler on the main thread.<br>After initiating a reverse-geocoding request, do not attempt to initiate another reverse- or forward-geocoding request. Geocoding requests are rate-limited for each app, so making too many requests in a short period of time may cause some of the requests to fail. When the maximum rate is exceeded, the geocoder passes an error object with the value kCLErrorNetwork to your completion handler.</p>
</blockquote></p>
<p>划重点：</p>
<ol>
<li>这个方法是异步的。</li>
<li>同一个app在一段时间间隔内会有一个调用频率（rate-limited）。经测试， geocoding server一次可以处理的请求数为50个，并且时间间隔大约在1分钟左右。</li>
</ol>
<p>针对以上两点，我采用了dispatch_group，每一个请求结束后leave group，并且notify到主线程，将结果写入另外的文件。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)geocodingForLocations:(<span class="built_in">NSArray</span> *)locations &#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    [locations enumerateObjectsUsingBlock:^(<span class="keyword">id</span>  _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        <span class="built_in">CLLocation</span> *location = obj;</span><br><span class="line">        </span><br><span class="line">        dispatch_group_enter(group);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CLGeocoder</span> *geocoder = [[<span class="built_in">CLGeocoder</span> alloc] init];</span><br><span class="line">        [geocoder reverseGeocodeLocation:location completionHandler:^(<span class="built_in">NSArray</span>&lt;<span class="built_in">CLPlacemark</span> *&gt; * _Nullable placemarks, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">CLPlacemark</span> * placemark <span class="keyword">in</span> placemarks) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"location：%@"</span>,location);</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"name：%@"</span>,placemark.name);</span><br><span class="line">                <span class="built_in">NSDecimalNumberHandler</span> *handle = [[<span class="built_in">NSDecimalNumberHandler</span> alloc] initWithRoundingMode:<span class="built_in">NSRoundDown</span> scale:<span class="number">6</span> raiseOnExactness:<span class="literal">NO</span> raiseOnOverflow:<span class="literal">NO</span> raiseOnUnderflow:<span class="literal">NO</span> raiseOnDivideByZero:<span class="literal">NO</span>] ;</span><br><span class="line">                <span class="built_in">NSDecimalNumber</span> *rLan = [[<span class="built_in">NSDecimalNumber</span> alloc] initWithDouble:location.coordinate.latitude];</span><br><span class="line">                <span class="built_in">NSDecimalNumber</span> *rLon = [[<span class="built_in">NSDecimalNumber</span> alloc] initWithDouble:location.coordinate.longitude];</span><br><span class="line">                rLan = [rLan decimalNumberByRoundingAccordingToBehavior:handle];</span><br><span class="line">                rLon = [rLon decimalNumberByRoundingAccordingToBehavior:handle];</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSString</span> *llllan = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%0.6f"</span>,location.coordinate.latitude];</span><br><span class="line">                <span class="built_in">NSString</span> *llllon = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%0.6f"</span>,location.coordinate.longitude];</span><br><span class="line"></span><br><span class="line">                <span class="built_in">NSString</span> *city = placemark.locality ?placemark.locality: placemark.administrativeArea;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"city：%@"</span>,city);</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                <span class="built_in">BOOL</span> same = <span class="literal">NO</span>;</span><br><span class="line">                <span class="built_in">NSString</span> *tempNameFromGoogle = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@-%@"</span>,rLan,rLon];</span><br><span class="line">                <span class="comment">//这里很耗时</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *dic <span class="keyword">in</span> <span class="keyword">self</span>.locationsOfGoogle) &#123;</span><br><span class="line">                    <span class="built_in">NSString</span> *latitude      = dic[<span class="string">@"lan"</span>];</span><br><span class="line">                    <span class="built_in">NSString</span> *longtitude    = dic[<span class="string">@"lon"</span>];</span><br><span class="line">                    <span class="built_in">NSString</span> *cityName      = dic[<span class="string">@"name"</span>];</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">NSComparisonResult</span> latiresult = [rLan compare:latitude];</span><br><span class="line"><span class="comment">//                    NSComparisonResult lonresult = [rLan compare:latitude];</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (([latitude isEqualToString:llllan] &amp;&amp; [longtitude isEqualToString:llllon]) || [cityName isEqualToString:city])&#123;</span><br><span class="line">                        <span class="comment">//找到对应的坐标判断城市名</span></span><br><span class="line">                        same = [cityName isEqualToString:city];</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@"城市名是否相同：%d--%f,%f"</span>,same,latitude.doubleValue,longtitude.doubleValue);</span><br><span class="line">                        tempNameFromGoogle = cityName;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">                [wself.citys appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%f,%f,%@,%d,%@\r\n"</span>,location.coordinate.latitude,location.coordinate.longitude, city,same,tempNameFromGoogle]];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"第%lu次 leave ： %lu"</span>,wself.k/<span class="number">50</span>,idx);</span><br><span class="line">            </span><br><span class="line">            dispatch_group_leave(group);</span><br><span class="line">            </span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第%lu次 notify"</span>,wself.k/<span class="number">50</span>);</span><br><span class="line">        [<span class="keyword">self</span> createFile];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>六: MKMapView的zoomLevel<br>系统类没有直接获取zoomLevel的属性，参考一下<br><a href="https://stackoverflow.com/questions/4189621/setting-the-zoom-level-for-a-mkmapview" target="_blank" rel="noopener">https://stackoverflow.com/questions/4189621/setting-the-zoom-level-for-a-mkmapview</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hl1987.com/2018/07/27/Mapkit基本开发指南/" data-id="cjw81wo0n000zmyf0lfxdsapx"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mapkit/">Mapkit</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2018/11/11/隐私政策/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            隐私政策
          
        </div>
      </a>
    
    
      <a href="/2018/07/19/YYCache-源码解析/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">YYCache 源码解析</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: '',
        owner: 'hanangellove',
        admin: [''],
        // id: location.pathname,      // Ensure uniqueness and length less than 50
        id: md5(location.pathname),
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  
  <div class="outer">
    <ul class="list-inline">
      <li>&copy; 2019 寒流‘s Blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
      <!--
      <li><a href="/">Han Liu</a></li>
      -->
    </ul>
  </div>
</footer>
</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>

<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="寒流‘s Blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">首页</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories/App">我的产品</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories/arch">架构</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories/principle">原理</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories/performance">性能</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories/iOSInterview">面试集</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/link">博客</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/categories">全部分类</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">关于</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Suche">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>

<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>

<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>


  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/search.js"></script>


<script src="/js/ocean.js"></script>

</body>
</html>